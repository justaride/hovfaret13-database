<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prosjekthistorikk - Hovfaret 13</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <style>
    /* ===== RESET & BASE ===== */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --bg-hover: #f1f5f9;
      --bg-selected: #eff6ff;
      --bg-accent: #dbeafe;

      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --text-accent: #2563eb;

      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;

      --green-primary: #22c55e;
      --green-light: #dcfce7;
      --orange-primary: #f59e0b;
      --orange-light: #fef3c7;
      --red-primary: #ef4444;
      --red-light: #fee2e2;
      --blue-primary: #3b82f6;
      --blue-light: #dbeafe;
      --purple-primary: #8b5cf6;
      --purple-light: #ede9fe;

      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);

      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 14px;
      min-height: 100vh;
    }

    /* ===== HEADER ===== */
    .app-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      color: white;
      padding: 1.5rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .back-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      transition: all 0.15s;
    }

    .back-link:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .page-subtitle {
      font-size: 0.875rem;
      color: rgba(255,255,255,0.6);
      margin-top: 0.25rem;
    }

    .header-stats {
      display: flex;
      gap: 2rem;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    .stat-label {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ===== HORIZONTAL TIMELINE ===== */
    .timeline-visual {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }

    .timeline-visual-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .timeline-visual-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .timeline-legend {
      display: flex;
      gap: 1.5rem;
      font-size: 0.75rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-dot.critical { background: var(--red-primary); }
    .legend-dot.strategic { background: var(--purple-primary); }
    .legend-dot.operational { background: var(--green-primary); }
    .legend-dot.current { background: var(--orange-primary); }

    .h-timeline-scroll {
      overflow-x: auto;
      padding-bottom: 1rem;
    }

    .h-timeline {
      display: flex;
      align-items: flex-start;
      min-width: max-content;
      padding: 1rem 0;
      position: relative;
    }

    .h-timeline::before {
      content: '';
      position: absolute;
      top: 60px;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--purple-primary), var(--blue-primary), var(--green-primary));
      border-radius: 2px;
    }

    .h-timeline-year {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
      padding: 0 0.5rem;
    }

    .h-timeline-year-label {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-primary);
      background: var(--bg-card);
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-sm);
      border: 2px solid var(--text-accent);
      margin-bottom: 1rem;
      z-index: 2;
    }

    .h-timeline-year-line {
      width: 2px;
      height: 20px;
      background: var(--text-accent);
    }

    .h-timeline-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 120px;
      max-width: 160px;
      padding: 0 0.5rem;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .h-timeline-item:hover {
      transform: translateY(-2px);
    }

    .h-timeline-date {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      white-space: nowrap;
    }

    .h-timeline-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 3px solid var(--blue-primary);
      z-index: 2;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
    }

    .h-timeline-item:hover .h-timeline-dot {
      transform: scale(1.2);
    }

    .h-timeline-item.critical .h-timeline-dot {
      border-color: var(--red-primary);
      background: var(--red-light);
      width: 20px;
      height: 20px;
    }

    .h-timeline-item.strategic .h-timeline-dot {
      border-color: var(--purple-primary);
      background: var(--purple-light);
    }

    .h-timeline-item.current .h-timeline-dot {
      border-color: var(--orange-primary);
      background: var(--orange-primary);
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
    }

    .h-timeline-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.3;
      max-width: 140px;
    }

    .h-timeline-item.critical .h-timeline-label {
      font-weight: 600;
      color: var(--red-primary);
    }

    /* ===== PHASE FILTERS ===== */
    .phase-filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .phase-filter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .phase-filter:hover {
      background: var(--bg-hover);
    }

    .phase-filter.active {
      background: var(--bg-accent);
      border-color: var(--text-accent);
      color: var(--text-accent);
    }

    .phase-filter-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    /* ===== PHASES SECTION ===== */
    .phases-container {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .phase-section {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .phase-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.25rem 1.5rem;
      background: linear-gradient(135deg, var(--bg-hover) 0%, var(--bg-card) 100%);
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: background 0.15s;
    }

    .phase-header:hover {
      background: var(--bg-hover);
    }

    .phase-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .phase-1 .phase-icon { background: #e0f2fe; }
    .phase-2 .phase-icon { background: #fee2e2; }
    .phase-3 .phase-icon { background: #dcfce7; }
    .phase-4 .phase-icon { background: #dbeafe; }
    .phase-5 .phase-icon { background: #fef3c7; }
    .phase-6 .phase-icon { background: #ede9fe; }

    .phase-info {
      flex: 1;
    }

    .phase-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .phase-period {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.125rem;
    }

    .phase-stats {
      display: flex;
      gap: 1rem;
    }

    .phase-stat {
      text-align: center;
      padding: 0.5rem 1rem;
      background: var(--bg-main);
      border-radius: var(--radius-sm);
    }

    .phase-stat-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-accent);
    }

    .phase-stat-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .phase-toggle {
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .phase-section.expanded .phase-toggle {
      transform: rotate(180deg);
    }

    .phase-content {
      display: none;
      padding: 1.5rem;
    }

    .phase-section.expanded .phase-content {
      display: block;
    }

    /* ===== EVENT CARDS ===== */
    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1rem;
    }

    .event-card {
      background: var(--bg-main);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      transition: all 0.15s;
      cursor: pointer;
    }

    .event-card:hover {
      border-color: var(--text-accent);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .event-card.critical {
      border-left: 4px solid var(--red-primary);
    }

    .event-card.strategic {
      border-left: 4px solid var(--purple-primary);
    }

    .event-card-header {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .event-date-box {
      min-width: 60px;
      padding: 0.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      text-align: center;
    }

    .event-date-day {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }

    .event-date-month {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .event-date-year {
      font-size: 0.7rem;
      color: var(--text-accent);
      font-weight: 500;
    }

    .event-title-area {
      flex: 1;
    }

    .event-badges {
      display: flex;
      gap: 0.375rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .event-badge {
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge-critical { background: var(--red-light); color: var(--red-primary); }
    .badge-high { background: var(--orange-light); color: var(--orange-primary); }
    .badge-strategic { background: var(--purple-light); color: var(--purple-primary); }
    .badge-operational { background: var(--green-light); color: var(--green-primary); }

    .event-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .event-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }

    .event-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .event-meta-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    /* ===== LINKED ITEMS ===== */
    .linked-items {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    .linked-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.5rem;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.15s;
    }

    .linked-item:hover {
      border-color: var(--text-accent);
      color: var(--text-accent);
    }

    /* ===== DETAIL MODAL ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 2rem;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      max-width: 700px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-section {
      margin-bottom: 1.5rem;
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.75rem;
    }

    .modal-meeting-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-main);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      text-decoration: none;
      color: inherit;
      transition: all 0.15s;
      margin-bottom: 0.5rem;
    }

    .modal-meeting-link:hover {
      border-color: var(--text-accent);
      background: var(--bg-hover);
    }

    .modal-meeting-icon {
      width: 36px;
      height: 36px;
      background: var(--bg-accent);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-accent);
    }

    .modal-meeting-info {
      flex: 1;
    }

    .modal-meeting-title {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .modal-meeting-date {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* ===== LOADING ===== */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem;
      color: var(--text-muted);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-light);
      border-top-color: var(--text-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .header-stats {
        display: none;
      }

      .events-grid {
        grid-template-columns: 1fr;
      }

      .phase-stats {
        display: none;
      }
    }
  
    /* Print styles */
    @media print {
        body { background: white !important; color: black !important; }
        .nav, .nav-bar, .header-nav, nav, .back-link, .auth-overlay, 
        .copy-btn, button:not([type="submit"]), .design-switcher,
        .hamburger, .mobile-menu { display: none !important; }
        .container, .app-container, main { 
            max-width: 100% !important; 
            margin: 0 !important; 
            padding: 1rem !important;
        }
        a { color: black !important; text-decoration: underline !important; }
        .card, .section, .slide-card { 
            break-inside: avoid !important;
            box-shadow: none !important;
            border: 1px solid #ddd !important;
        }
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    }

  </style>
    
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <div class="header-left">
        <a href="index.html" class="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Dashboard
        </a>
        <div>
          <h1 class="page-title">Prosjekthistorikk</h1>
          <p class="page-subtitle">Komplett tidslinje fra 1989 til i dag</p>
        </div>
      </div>
      <div class="header-stats">
        <div class="stat">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">Hendelser</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-strategic">-</div>
          <div class="stat-label">Strategiske</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-meetings">-</div>
          <div class="stat-label">Koblede mÃ¸ter</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Horizontal Timeline Visual -->
    <section class="timeline-visual">
      <div class="timeline-visual-header">
        <h2 class="timeline-visual-title">Visuell tidslinje</h2>
        <div class="timeline-legend">
          <div class="legend-item">
            <span class="legend-dot critical"></span>
            Kritisk
          </div>
          <div class="legend-item">
            <span class="legend-dot strategic"></span>
            Strategisk
          </div>
          <div class="legend-item">
            <span class="legend-dot operational"></span>
            Operasjonell
          </div>
          <div class="legend-item">
            <span class="legend-dot current"></span>
            I dag
          </div>
        </div>
      </div>
      <div class="h-timeline-scroll">
        <div class="h-timeline" id="h-timeline">
          <div class="loading-state">
            <div class="spinner"></div>
            <span>Laster tidslinje...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Tematiske Tidslinjer -->
    <section class="thematic-timelines" style="margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-primary);">Tematiske tidslinjer</h3>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
        <a href="stakeholder-journey.html" style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, rgba(167, 139, 250, 0.1) 100%); border: 1px solid rgba(34, 211, 238, 0.3); border-radius: var(--radius-lg); text-decoration: none; transition: all 0.2s;">
          <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #22d3ee, #a78bfa); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">ðŸ‘¥</div>
          <div>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Interessentreisen</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">Dialoger med bydel, politikere, leietakere</div>
          </div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto; color: var(--text-muted);">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </a>
        <a href="project-story.html" style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: var(--radius-lg); text-decoration: none; transition: all 0.2s;">
          <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">ðŸ“–</div>
          <div>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">Prosjekthistorie</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">Komplett dokumentasjon med alle detaljer</div>
          </div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto; color: var(--text-muted);">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </a>
      </div>
    </section>

    <!-- Phase Filters -->
    <div class="phase-filters" id="phase-filters">
      <button class="phase-filter active" data-phase="all">
        Alle faser
      </button>
    </div>

    <!-- Phases Container -->
    <div class="phases-container" id="phases-container">
      <div class="loading-state">
        <div class="spinner"></div>
        <span>Laster prosjekthistorikk...</span>
      </div>
    </div>
  </main>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal-content" id="modal-content">
      <!-- Filled by JS -->
    </div>
  </div>

  <!-- Scripts -->
  <script src="lib/data-loader.js"></script>
  <script>
    // ===== STATE =====
    let allEvents = [];
    let allMeetings = [];
    let phases = {};
    let activePhase = 'all';

    // ===== PHASE DEFINITIONS =====
    const phaseDefinitions = {
      'phase_1': {
        name: 'Historisk bakgrunn',
        period: '1989 - 2023',
        icon: 'ðŸ›ï¸',
        description: 'Byggets opprinnelse og regulatorisk kontekst'
      },
      'phase_2': {
        name: 'Rivingstrussel',
        period: 'September 2023',
        icon: 'âš ï¸',
        description: 'OmrÃ¥deplan krever riving'
      },
      'phase_3': {
        name: 'Prosjektoppstart',
        period: 'Januar - Mai 2024',
        icon: 'ðŸš€',
        description: 'FÃ¸rste mÃ¸ter og konseptutvikling'
      },
      'phase_4': {
        name: 'Scenarioutvikling',
        period: 'Mai - Desember 2024',
        icon: 'ðŸ“',
        description: '6 scenarier utviklet med R21'
      },
      'phase_5': {
        name: 'Dokumentasjon',
        period: 'Januar - Juli 2025',
        icon: 'ðŸ“Š',
        description: 'Energi, klima og bÃ¦rekraftsrapporter'
      },
      'phase_6': {
        name: 'SÃ¸knadsforberedelse',
        period: 'August 2025 - ',
        icon: 'ðŸ“‹',
        description: 'Forberedelse av rammesÃ¸knad'
      }
    };

    // ===== HELPERS =====
    function formatDate(dateStr) {
      if (!dateStr) return { day: '?', month: '', year: '' };

      // Handle year only
      if (/^\d{4}$/.test(dateStr)) {
        return { day: '', month: '', year: dateStr };
      }

      // Handle Q format
      const qMatch = dateStr.match(/Q(\d)\s*(\d{4})/);
      if (qMatch) {
        const quarters = ['Jan-Mar', 'Apr-Jun', 'Jul-Sep', 'Okt-Des'];
        return { day: `Q${qMatch[1]}`, month: quarters[parseInt(qMatch[1])-1], year: qMatch[2] };
      }

      // Handle year-month
      if (/^\d{4}-\d{2}$/.test(dateStr)) {
        const [year, month] = dateStr.split('-');
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Des'];
        return { day: '', month: months[parseInt(month)-1], year: year };
      }

      // Handle full date
      const date = new Date(dateStr);
      if (!isNaN(date)) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Des'];
        return {
          day: date.getDate().toString(),
          month: months[date.getMonth()],
          year: date.getFullYear().toString()
        };
      }

      return { day: dateStr, month: '', year: '' };
    }

    function formatDateShort(dateStr) {
      if (!dateStr) return '?';

      if (/^\d{4}$/.test(dateStr)) return dateStr;

      const qMatch = dateStr.match(/Q(\d)\s*(\d{4})/);
      if (qMatch) return `Q${qMatch[1]} ${qMatch[2]}`;

      if (/^\d{4}-\d{2}$/.test(dateStr)) {
        const [year, month] = dateStr.split('-');
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Des'];
        return `${months[parseInt(month)-1]} ${year}`;
      }

      const date = new Date(dateStr);
      if (!isNaN(date)) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Des'];
        return `${date.getDate()} ${months[date.getMonth()]}`;
      }

      return dateStr;
    }

    function sanitize(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ===== HORIZONTAL TIMELINE =====
    function renderHorizontalTimeline() {
      const container = document.getElementById('h-timeline');

      // Sort events by date
      const sortedEvents = [...allEvents].sort((a, b) => {
        const dateA = a.date || '';
        const dateB = b.date || '';
        return dateA.localeCompare(dateB);
      });

      // Group by year
      let html = '';
      let currentYear = null;
      const today = new Date().toISOString().split('T')[0];
      let addedCurrentMarker = false;

      sortedEvents.forEach((event, index) => {
        const yearMatch = (event.date || '').match(/(\d{4})/);
        const year = yearMatch ? yearMatch[1] : null;

        // Add year marker
        if (year && year !== currentYear) {
          html += `
            <div class="h-timeline-year">
              <div class="h-timeline-year-label">${year}</div>
              <div class="h-timeline-year-line"></div>
            </div>
          `;
          currentYear = year;
        }

        // Check if we should add "today" marker
        if (!addedCurrentMarker && event.date && event.date > today) {
          html += `
            <div class="h-timeline-item current" title="I dag">
              <div class="h-timeline-date">I dag</div>
              <div class="h-timeline-dot"></div>
              <div class="h-timeline-label">NÃ¥vÃ¦rende status</div>
            </div>
          `;
          addedCurrentMarker = true;
        }

        // Add event
        const isCritical = event.importance === 'critical';
        const isStrategic = event.layer === 'strategic';
        const classes = [
          'h-timeline-item',
          isCritical ? 'critical' : '',
          isStrategic ? 'strategic' : ''
        ].filter(Boolean).join(' ');

        const title = event.title_no || event.title || 'Ukjent';
        const shortTitle = title.length > 30 ? title.substring(0, 30) + '...' : title;

        html += `
          <div class="${classes}" data-id="${event.id}" onclick="showEventDetail('${event.id}')">
            <div class="h-timeline-date">${formatDateShort(event.date)}</div>
            <div class="h-timeline-dot"></div>
            <div class="h-timeline-label">${sanitize(shortTitle)}</div>
          </div>
        `;
      });

      // Add current marker at end if not added
      if (!addedCurrentMarker) {
        html += `
          <div class="h-timeline-item current" title="I dag">
            <div class="h-timeline-date">I dag</div>
            <div class="h-timeline-dot"></div>
            <div class="h-timeline-label">NÃ¥vÃ¦rende status</div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    // ===== PHASE FILTERS =====
    function renderPhaseFilters() {
      const container = document.getElementById('phase-filters');

      let html = `
        <button class="phase-filter active" data-phase="all" onclick="setPhaseFilter('all')">
          Alle faser
        </button>
      `;

      Object.entries(phaseDefinitions).forEach(([phaseId, phase]) => {
        const count = phases[phaseId]?.length || 0;
        if (count > 0) {
          html += `
            <button class="phase-filter" data-phase="${phaseId}" onclick="setPhaseFilter('${phaseId}')">
              ${phase.icon} ${phase.name} (${count})
            </button>
          `;
        }
      });

      container.innerHTML = html;
    }

    function setPhaseFilter(phaseId) {
      activePhase = phaseId;

      // Update buttons
      document.querySelectorAll('.phase-filter').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.phase === phaseId);
      });

      // Update visibility
      document.querySelectorAll('.phase-section').forEach(section => {
        if (phaseId === 'all') {
          section.style.display = 'block';
        } else {
          section.style.display = section.dataset.phase === phaseId ? 'block' : 'none';
        }
      });
    }

    // ===== PHASES RENDERING =====
    function renderPhases() {
      const container = document.getElementById('phases-container');

      let html = '';

      Object.entries(phaseDefinitions).forEach(([phaseId, phaseDef]) => {
        const events = phases[phaseId] || [];
        if (events.length === 0) return;

        const strategicCount = events.filter(e => e.layer === 'strategic').length;
        const linkedMeetings = events.reduce((sum, e) => sum + (e.linked_meetings?.length || 0), 0);

        html += `
          <div class="phase-section expanded ${phaseId}" data-phase="${phaseId}">
            <div class="phase-header" onclick="togglePhase(this)">
              <div class="phase-icon">${phaseDef.icon}</div>
              <div class="phase-info">
                <div class="phase-name">${phaseDef.name}</div>
                <div class="phase-period">${phaseDef.period} â€” ${phaseDef.description}</div>
              </div>
              <div class="phase-stats">
                <div class="phase-stat">
                  <div class="phase-stat-value">${events.length}</div>
                  <div class="phase-stat-label">Hendelser</div>
                </div>
                <div class="phase-stat">
                  <div class="phase-stat-value">${strategicCount}</div>
                  <div class="phase-stat-label">Strategiske</div>
                </div>
                <div class="phase-stat">
                  <div class="phase-stat-value">${linkedMeetings}</div>
                  <div class="phase-stat-label">MÃ¸ter</div>
                </div>
              </div>
              <svg class="phase-toggle" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
            <div class="phase-content">
              <div class="events-grid">
                ${events.map(e => renderEventCard(e)).join('')}
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderEventCard(event) {
      const dateInfo = formatDate(event.date);
      const isCritical = event.importance === 'critical';
      const isHigh = event.importance === 'high';
      const isStrategic = event.layer === 'strategic';
      const linkedMeetings = event.linked_meetings || [];
      const linkedDocs = event.linked_documents || [];

      const title = event.title_no || event.title || 'Ukjent hendelse';
      const description = event.description || '';

      const cardClasses = [
        'event-card',
        isCritical ? 'critical' : '',
        isStrategic ? 'strategic' : ''
      ].filter(Boolean).join(' ');

      return `
        <div class="${cardClasses}" onclick="showEventDetail('${event.id}')">
          <div class="event-card-header">
            <div class="event-date-box">
              ${dateInfo.day ? `<div class="event-date-day">${dateInfo.day}</div>` : ''}
              ${dateInfo.month ? `<div class="event-date-month">${dateInfo.month}</div>` : ''}
              <div class="event-date-year">${dateInfo.year}</div>
            </div>
            <div class="event-title-area">
              <div class="event-badges">
                ${isCritical ? '<span class="event-badge badge-critical">Kritisk</span>' : ''}
                ${isHigh ? '<span class="event-badge badge-high">HÃ¸y</span>' : ''}
                ${isStrategic ? '<span class="event-badge badge-strategic">Strategisk</span>' : '<span class="event-badge badge-operational">Operasjonell</span>'}
              </div>
              <div class="event-title">${sanitize(title)}</div>
            </div>
          </div>
          ${description ? `<div class="event-description">${sanitize(description.substring(0, 150))}${description.length > 150 ? '...' : ''}</div>` : ''}
          <div class="event-meta">
            ${linkedMeetings.length > 0 ? `
              <span class="event-meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                ${linkedMeetings.length} mÃ¸te${linkedMeetings.length > 1 ? 'r' : ''}
              </span>
            ` : ''}
            ${linkedDocs.length > 0 ? `
              <span class="event-meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                </svg>
                ${linkedDocs.length} dok
              </span>
            ` : ''}
            ${event.source_verified ? `
              <span class="event-meta-item" style="color: var(--green-primary);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Verifisert
              </span>
            ` : ''}
          </div>
        </div>
      `;
    }

    function togglePhase(header) {
      const section = header.parentElement;
      section.classList.toggle('expanded');
    }

    // ===== EVENT DETAIL MODAL =====
    function showEventDetail(eventId) {
      const event = allEvents.find(e => e.id === eventId);
      if (!event) return;

      const linkedMeetings = (event.linked_meetings || [])
        .map(id => allMeetings.find(m => m.id === id))
        .filter(Boolean);

      const linkedDocs = event.linked_documents || [];
      const title = event.title_no || event.title || 'Ukjent hendelse';
      const description = event.description || '';

      const modal = document.getElementById('modal-content');
      modal.innerHTML = `
        <div class="modal-header">
          <div>
            <div class="event-badges" style="margin-bottom: 0.5rem;">
              ${event.importance === 'critical' ? '<span class="event-badge badge-critical">Kritisk</span>' : ''}
              ${event.importance === 'high' ? '<span class="event-badge badge-high">HÃ¸y prioritet</span>' : ''}
              ${event.layer === 'strategic' ? '<span class="event-badge badge-strategic">Strategisk</span>' : '<span class="event-badge badge-operational">Operasjonell</span>'}
            </div>
            <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary);">${sanitize(title)}</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.25rem;">
              ðŸ“… ${formatDateShort(event.date)}
              ${phaseDefinitions[event.phase] ? ` Â· ${phaseDefinitions[event.phase].icon} ${phaseDefinitions[event.phase].name}` : ''}
            </p>
          </div>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
          ${description ? `
            <div class="modal-section">
              <div class="modal-section-title">Beskrivelse</div>
              <p style="color: var(--text-secondary); line-height: 1.6;">${sanitize(description)}</p>
            </div>
          ` : ''}

          ${event.source_verified ? `
            <div class="modal-section">
              <div class="modal-section-title">Kildeverifisering</div>
              <p style="color: var(--green-primary); font-size: 0.9rem;">
                âœ“ ${sanitize(event.source_verified)}
              </p>
            </div>
          ` : ''}

          ${linkedMeetings.length > 0 ? `
            <div class="modal-section">
              <div class="modal-section-title">Koblede mÃ¸ter (${linkedMeetings.length})</div>
              ${linkedMeetings.map(m => `
                <a href="meetings.html#${m.id}" class="modal-meeting-link">
                  <div class="modal-meeting-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                      <line x1="16" y1="2" x2="16" y2="6"/>
                      <line x1="8" y1="2" x2="8" y2="6"/>
                      <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                  </div>
                  <div class="modal-meeting-info">
                    <div class="modal-meeting-title">${sanitize(m.title)}</div>
                    <div class="modal-meeting-date">${m.date || 'Ukjent dato'}</div>
                  </div>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);">
                    <polyline points="9 18 15 12 9 6"/>
                  </svg>
                </a>
              `).join('')}
            </div>
          ` : ''}

          ${linkedDocs.length > 0 ? `
            <div class="modal-section">
              <div class="modal-section-title">Koblede dokumenter (${linkedDocs.length})</div>
              ${linkedDocs.map(docId => `
                <div class="modal-meeting-link" style="cursor: default;">
                  <div class="modal-meeting-icon" style="background: #e0e7ff; color: #6366f1;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                    </svg>
                  </div>
                  <div class="modal-meeting-info">
                    <div class="modal-meeting-title">${sanitize(docId)}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;

      document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('active');
    }

    // Close modal on overlay click
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'modal-overlay') {
        closeModal();
      }
    });

    // Close modal on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // ===== INITIALIZATION =====
    async function init() {
      try {
        const data = await DataLoader.loadAllData();

        // Combine strategic and operational events
        const strategic = (data.timeline?.events?.strategic || []).map(e => ({ ...e, layer: 'strategic' }));
        const operational = (data.timeline?.events?.operational || []).map(e => ({ ...e, layer: 'operational' }));
        allEvents = [...strategic, ...operational];
        allMeetings = data.meetings || [];

        // Group by phase
        phases = {};
        allEvents.forEach(event => {
          const phase = event.phase || 'unknown';
          if (!phases[phase]) phases[phase] = [];
          phases[phase].push(event);
        });

        // Sort events within each phase by date
        Object.values(phases).forEach(phaseEvents => {
          phaseEvents.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
        });

        // Count linked meetings
        const totalLinkedMeetings = allEvents.reduce((sum, e) => sum + (e.linked_meetings?.length || 0), 0);

        // Update stats
        document.getElementById('stat-total').textContent = allEvents.length;
        document.getElementById('stat-strategic').textContent = strategic.length;
        document.getElementById('stat-meetings').textContent = totalLinkedMeetings;

        // Render
        renderHorizontalTimeline();
        renderPhaseFilters();
        renderPhases();

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('phases-container').innerHTML = `
          <div class="loading-state">
            <span>Feil ved lasting: ${error.message}</span>
          </div>
        `;
      }
    }

    // Start
    init();
  </script>
</body>
</html>
