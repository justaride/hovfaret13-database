<!doctype html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="description"
      content="Leveranser - 37 verifiserte prosjektleveranser med status og ansvarlige"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leveranser - Hovfaret 13</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    />
    <style>
      /* ===== RESET & BASE ===== */
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-main: #f8fafc;
        --bg-card: #ffffff;
        --bg-hover: #f1f5f9;
        --bg-selected: #eff6ff;
        --bg-accent: #dbeafe;

        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-muted: #94a3b8;
        --text-accent: #2563eb;

        --border-light: #e2e8f0;
        --border-medium: #cbd5e1;

        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md:
          0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);

        --color-completed: #10b981;
        --color-in-progress: #f59e0b;
        --color-not-started: #94a3b8;
        --color-critical: #ef4444;

        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;
        --space-8: 2rem;

        --radius-sm: 6px;
        --radius-md: 8px;
        --radius-lg: 12px;
      }

      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
        background: var(--bg-main);
        color: var(--text-primary);
        line-height: 1.5;
        font-size: 14px;
        height: 100vh;
        overflow: hidden;
      }

      .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      /* Header */
      .app-header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-light);
        padding: var(--space-4) var(--space-6);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: var(--space-4);
      }

      .back-link {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-sm);
        transition: all 0.15s;
      }

      .back-link:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
      }

      .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .header-stats {
        display: flex;
        gap: var(--space-6);
      }

      .stat {
        text-align: center;
      }

      .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-accent);
      }

      .stat-value.completed {
        color: var(--color-completed);
      }
      .stat-value.in-progress {
        color: var(--color-in-progress);
      }

      .stat-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Main Content */
      .main-content {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* Left Panel */
      .list-panel {
        width: 420px;
        min-width: 420px;
        background: var(--bg-card);
        border-right: 1px solid var(--border-light);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .list-controls {
        padding: var(--space-4);
        border-bottom: 1px solid var(--border-light);
        background: var(--bg-card);
      }

      .search-container {
        position: relative;
        margin-bottom: var(--space-3);
      }

      .search-icon {
        position: absolute;
        left: var(--space-3);
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
      }

      .search-input {
        width: 100%;
        padding: var(--space-3) var(--space-3) var(--space-3) 2.5rem;
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        transition: all 0.15s;
        background: var(--bg-main);
      }

      .search-input:focus {
        outline: none;
        border-color: var(--text-accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        background: var(--bg-card);
      }

      .filter-row {
        display: flex;
        gap: var(--space-2);
      }

      .filter-select {
        flex: 1;
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-sm);
        font-size: 0.8rem;
        color: var(--text-secondary);
        background: var(--bg-card);
        cursor: pointer;
      }

      .filter-select:focus {
        outline: none;
        border-color: var(--text-accent);
      }

      .results-info {
        padding: var(--space-2) var(--space-4);
        background: var(--bg-main);
        border-bottom: 1px solid var(--border-light);
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      /* Deliverable List */
      .deliverable-list {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-2);
      }

      .category-group {
        margin-bottom: var(--space-4);
      }

      .category-header {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        background: var(--bg-main);
        z-index: 10;
      }

      .category-count {
        background: var(--border-light);
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 500;
      }

      .deliverable-item {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3);
        margin: var(--space-1) 0;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.15s;
        border: 1px solid transparent;
      }

      .deliverable-item:hover {
        background: var(--bg-hover);
      }

      .deliverable-item.selected {
        background: var(--bg-selected);
        border-color: var(--text-accent);
      }

      .deliverable-status {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
      }

      .deliverable-status.completed {
        background: #d1fae5;
        color: var(--color-completed);
      }

      .deliverable-status.in_progress,
      .deliverable-status.in_production,
      .deliverable-status.in_planning {
        background: #fef3c7;
        color: var(--color-in-progress);
      }

      .deliverable-status.not_started {
        background: #f1f5f9;
        color: var(--text-muted);
      }

      .deliverable-content {
        flex: 1;
        min-width: 0;
      }

      .deliverable-name {
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .deliverable-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: var(--space-2);
      }

      .importance-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .importance-badge.critical {
        background: #fef2f2;
        color: var(--color-critical);
      }

      .importance-badge.high {
        background: #fef3c7;
        color: #d97706;
      }

      /* Right Panel */
      .detail-panel {
        flex: 1;
        overflow-y: auto;
        background: var(--bg-main);
      }

      .detail-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-muted);
        text-align: center;
        padding: var(--space-8);
      }

      .detail-empty-icon {
        font-size: 4rem;
        margin-bottom: var(--space-4);
        opacity: 0.3;
      }

      .detail-empty h3 {
        font-size: 1.25rem;
        color: var(--text-secondary);
        margin-bottom: var(--space-2);
      }

      .detail-content {
        max-width: 800px;
        margin: 0 auto;
        padding: var(--space-6);
      }

      .detail-header {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-4);
        box-shadow: var(--shadow-sm);
      }

      .detail-status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: var(--space-4);
      }

      .detail-status-badge.completed {
        background: #d1fae5;
        color: var(--color-completed);
      }

      .detail-status-badge.in_progress,
      .detail-status-badge.in_production,
      .detail-status-badge.in_planning {
        background: #fef3c7;
        color: var(--color-in-progress);
      }

      .detail-status-badge.not_started {
        background: #f1f5f9;
        color: var(--text-muted);
      }

      .detail-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-3);
        word-break: break-word;
      }

      .detail-meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
      }

      .meta-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
      }

      .meta-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .meta-value {
        font-size: 0.875rem;
        color: var(--text-primary);
        font-weight: 500;
      }

      .category-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 500;
        background: var(--bg-accent);
        color: var(--text-accent);
      }

      /* Detail Section */
      .detail-section {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-4);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-4) var(--space-5);
        cursor: pointer;
        transition: background 0.15s;
      }

      .section-header:hover {
        background: var(--bg-hover);
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-primary);
      }

      .section-title svg {
        color: var(--text-accent);
      }

      .section-toggle {
        color: var(--text-muted);
        transition: transform 0.2s;
      }

      .detail-section.expanded .section-toggle {
        transform: rotate(180deg);
      }

      .section-content {
        display: none;
        padding: var(--space-5);
        border-top: 1px solid var(--border-light);
      }

      .detail-section.expanded .section-content {
        display: block;
      }

      /* Timeline in detail */
      .timeline-mini {
        position: relative;
        padding-left: var(--space-6);
      }

      .timeline-mini::before {
        content: "";
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-light);
      }

      .timeline-mini-item {
        position: relative;
        padding-bottom: var(--space-4);
      }

      .timeline-mini-item::before {
        content: "";
        position: absolute;
        left: -22px;
        top: 4px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--text-accent);
        border: 2px solid var(--bg-card);
      }

      .timeline-mini-date {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: var(--space-1);
      }

      .timeline-mini-label {
        font-size: 0.875rem;
        color: var(--text-primary);
      }

      /* Responsible list */
      .responsible-list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      .responsible-chip {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        background: var(--bg-main);
        border-radius: 20px;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .responsible-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--text-accent);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
      }

      /* Loading */
      .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--space-8);
        color: var(--text-muted);
      }

      .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-light);
        border-top-color: var(--text-accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: var(--space-4);
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Progress bar */
      .progress-bar-container {
        background: var(--border-light);
        border-radius: 4px;
        height: 8px;
        overflow: hidden;
        margin-top: var(--space-2);
      }

      .progress-bar {
        height: 100%;
        background: var(--color-completed);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-medium);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .list-panel {
          width: 360px;
          min-width: 360px;
        }
      }

      @media (max-width: 768px) {
        .main-content {
          flex-direction: column;
        }

        .list-panel {
          width: 100%;
          min-width: 100%;
          max-height: 50vh;
        }

        .header-stats {
          display: none;
        }
      }
    </style>
    <link rel="stylesheet" href="css/tabs.css" />
  </head>
  <body>
    <div class="app-container">
      <!-- Main Content -->
      <div
        class="header-stats"
        style="
          background: var(--bg-card);
          border-bottom: 1px solid var(--border-light);
          padding: var(--space-3) var(--space-6);
          display: flex;
          justify-content: flex-end;
          gap: var(--space-6);
          flex-shrink: 0;
        "
      >
        <div class="stat">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">Totalt</div>
        </div>
        <div class="stat">
          <div class="stat-value completed" id="stat-completed">-</div>
          <div class="stat-label">Fullf√∏rt</div>
        </div>
        <div class="stat">
          <div class="stat-value in-progress" id="stat-progress">-</div>
          <div class="stat-label">P√•g√•r</div>
        </div>
      </div>

      <main class="main-content">
        <!-- Left Panel -->
        <aside class="list-panel">
          <div class="list-controls">
            <div class="search-container">
              <svg
                class="search-icon"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
              </svg>
              <input
                type="text"
                class="search-input"
                id="search-input"
                placeholder="S√∏k i leveranser..."
              />
            </div>
            <div class="filter-row">
              <select class="filter-select" id="filter-category">
                <option value="all">Alle kategorier</option>
              </select>
              <select class="filter-select" id="filter-status">
                <option value="all">Alle statuser</option>
                <option value="completed">Fullf√∏rt</option>
                <option value="in_progress">P√•g√•r</option>
                <option value="not_started">Ikke startet</option>
              </select>
            </div>
          </div>
          <div class="results-info" id="results-info">Laster leveranser...</div>
          <div class="deliverable-list" id="deliverable-list">
            <div class="loading-state">
              <div class="spinner"></div>
              <span>Laster leveranser...</span>
            </div>
          </div>
        </aside>

        <!-- Right Panel -->
        <section class="detail-panel" id="detail-panel">
          <div class="detail-empty">
            <div class="detail-empty-icon">üìã</div>
            <h3>Velg en leveranse</h3>
            <p>Velg en leveranse fra listen for √• se detaljer</p>
          </div>
        </section>
      </main>
    </div>

    <!-- Scripts -->
    <script src="lib/page-config.js"></script>
    <script src="lib/tab-router.js"></script>
    <script src="components/content-header.js"></script>
    <script>
      // ===== STATE =====
      let allDeliverables = [];
      let categories = [];
      let filteredDeliverables = [];
      let selectedId = null;
      let searchQuery = "";
      let categoryFilter = "all";
      let statusFilter = "all";
      let peopleMap = {};

      // ===== HELPERS =====
      function getStatusIcon(status) {
        const icons = {
          completed: "‚úì",
          in_progress: "‚óê",
          in_production: "‚óê",
          in_planning: "‚óê",
          not_started: "‚óã",
        };
        return icons[status] || "‚óã";
      }

      function getStatusLabel(status) {
        const labels = {
          completed: "Fullf√∏rt",
          in_progress: "P√•g√•r",
          in_production: "I produksjon",
          in_planning: "Planlegges",
          not_started: "Ikke startet",
        };
        return labels[status] || status;
      }

      function getCategoryEmoji(catId) {
        const emojis = {
          cat_01: "üèòÔ∏è",
          cat_02: "üåê",
          cat_03: "üì±",
          cat_04: "üè¢",
          cat_05: "üìù",
          cat_06: "‚úèÔ∏è",
          cat_07: "üå±",
          cat_08: "üë¥",
          cat_09: "üí∞",
          cat_10: "ü§ù",
          cat_11: "üì¶",
        };
        return emojis[catId] || "üìã";
      }

      function sanitize(str) {
        if (!str) return "";
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      }

      function formatDate(dateStr) {
        if (!dateStr) return "";
        const date = new Date(dateStr);
        return date.toLocaleDateString("no-NO", {
          day: "numeric",
          month: "short",
          year: "numeric",
        });
      }

      function getInitials(name) {
        if (!name) return "?";
        return name
          .split(" ")
          .map((n) => n[0])
          .join("")
          .toUpperCase()
          .slice(0, 2);
      }

      // ===== FILTERING =====
      function applyFilters() {
        let items = [...allDeliverables];

        // Search
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          items = items.filter(
            (d) =>
              (d.title || "").toLowerCase().includes(query) ||
              (d.title_no || "").toLowerCase().includes(query),
          );
        }

        // Category filter
        if (categoryFilter !== "all") {
          items = items.filter((d) => d.category === categoryFilter);
        }

        // Status filter
        if (statusFilter !== "all") {
          if (statusFilter === "in_progress") {
            items = items.filter((d) =>
              ["in_progress", "in_production", "in_planning"].includes(
                d.status,
              ),
            );
          } else {
            items = items.filter((d) => d.status === statusFilter);
          }
        }

        // Sort: critical first, then by date
        items.sort((a, b) => {
          if (a.importance === "critical" && b.importance !== "critical")
            return -1;
          if (b.importance === "critical" && a.importance !== "critical")
            return 1;
          const dateA = a.dates?.end || a.dates?.start || "";
          const dateB = b.dates?.end || b.dates?.start || "";
          return dateB.localeCompare(dateA);
        });

        filteredDeliverables = items;
        renderDeliverableList();
      }

      // ===== RENDERING =====
      function renderDeliverableList() {
        const container = document.getElementById("deliverable-list");
        const resultsInfo = document.getElementById("results-info");

        resultsInfo.textContent = `Viser ${filteredDeliverables.length} av ${allDeliverables.length} leveranser`;

        if (filteredDeliverables.length === 0) {
          container.innerHTML =
            '<div class="loading-state"><span>Ingen leveranser funnet</span></div>';
          return;
        }

        // Group by category
        const groups = {};
        filteredDeliverables.forEach((del) => {
          const cat = del.category || "other";
          if (!groups[cat]) {
            groups[cat] = [];
          }
          groups[cat].push(del);
        });

        // Sort categories by count
        const sortedCategories = Object.keys(groups).sort(
          (a, b) => groups[b].length - groups[a].length,
        );

        let html = "";
        sortedCategories.forEach((catId) => {
          const cat = categories.find((c) => c.id === catId) || {
            name_no: catId,
            name: catId,
          };
          const emoji = getCategoryEmoji(catId);
          html += `
          <div class="category-group">
            <div class="category-header">
              <span>${emoji} ${cat.name_no || cat.name}</span>
              <span class="category-count">${groups[catId].length}</span>
            </div>
            ${groups[catId].map((del) => renderDeliverableItem(del)).join("")}
          </div>
        `;
        });

        container.innerHTML = html;

        // Add click handlers
        container.querySelectorAll(".deliverable-item").forEach((item) => {
          item.addEventListener("click", () => {
            selectDeliverable(item.dataset.id);
          });
        });

        // Re-select if needed
        if (selectedId) {
          const selectedItem = container.querySelector(
            `[data-id="${selectedId}"]`,
          );
          if (selectedItem) {
            selectedItem.classList.add("selected");
          }
        }
      }

      function renderDeliverableItem(del) {
        const isSelected = del.id === selectedId;
        const statusIcon = getStatusIcon(del.status);
        const dateStr = del.dates?.end ? formatDate(del.dates.end) : "";

        let importanceBadge = "";
        if (del.importance === "critical") {
          importanceBadge =
            '<span class="importance-badge critical">Kritisk</span>';
        } else if (del.importance === "high") {
          importanceBadge = '<span class="importance-badge high">H√∏y</span>';
        }

        return `
        <div class="deliverable-item ${isSelected ? "selected" : ""}" data-id="${del.id}">
          <div class="deliverable-status ${del.status}">${statusIcon}</div>
          <div class="deliverable-content">
            <div class="deliverable-name">${sanitize(del.title_no || del.title)}</div>
            <div class="deliverable-meta">
              ${dateStr}
              ${importanceBadge}
            </div>
          </div>
        </div>
      `;
      }

      function selectDeliverable(delId) {
        selectedId = delId;

        // Update list selection
        document.querySelectorAll(".deliverable-item").forEach((item) => {
          item.classList.toggle("selected", item.dataset.id === delId);
        });

        // Render detail
        const del = allDeliverables.find((d) => d.id === delId);
        if (del) {
          renderDeliverableDetail(del);
        }
      }

      function renderDeliverableDetail(del) {
        const panel = document.getElementById("detail-panel");
        const cat = categories.find((c) => c.id === del.category) || {
          name_no: del.category,
          name: del.category,
        };
        const emoji = getCategoryEmoji(del.category);

        // Build responsible section
        let responsibleHtml = "";
        if (del.responsible && del.responsible.length > 0) {
          const chips = del.responsible
            .map((personId) => {
              const person = peopleMap[personId];
              const name = person ? person.name : personId;
              const initials = getInitials(name);
              return `
            <span class="responsible-chip">
              <span class="responsible-avatar">${initials}</span>
              ${sanitize(name)}
            </span>
          `;
            })
            .join("");
          responsibleHtml = `
          <div class="detail-section expanded">
            <div class="section-header" onclick="toggleSection(this)">
              <span class="section-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Ansvarlige
              </span>
              <svg class="section-toggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
            <div class="section-content">
              <div class="responsible-list">${chips}</div>
            </div>
          </div>
        `;
        }

        // Build timeline section
        let timelineHtml = "";
        if (del.dates && (del.dates.start || del.dates.end)) {
          let timelineItems = "";
          if (del.dates.start) {
            timelineItems += `
            <div class="timeline-mini-item">
              <div class="timeline-mini-date">${formatDate(del.dates.start)}</div>
              <div class="timeline-mini-label">Startet</div>
            </div>
          `;
          }
          if (del.dates.end) {
            timelineItems += `
            <div class="timeline-mini-item">
              <div class="timeline-mini-date">${formatDate(del.dates.end)}</div>
              <div class="timeline-mini-label">${del.status === "completed" ? "Fullf√∏rt" : "Planlagt ferdig"}</div>
            </div>
          `;
          }
          timelineHtml = `
          <div class="detail-section expanded">
            <div class="section-header" onclick="toggleSection(this)">
              <span class="section-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Tidslinje
              </span>
              <svg class="section-toggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
            <div class="section-content">
              <div class="timeline-mini">${timelineItems}</div>
            </div>
          </div>
        `;
        }

        // Related links
        let linksHtml = "";
        if (
          (del.linked_meetings && del.linked_meetings.length > 0) ||
          (del.linked_timeline_events &&
            del.linked_timeline_events.length > 0) ||
          del.url
        ) {
          let linkItems = "";
          if (del.url) {
            linkItems += `<div style="margin-bottom: 0.5rem;"><a href="${del.url}" target="_blank" style="color: var(--text-accent);">${del.url}</a></div>`;
          }
          if (del.linked_meetings && del.linked_meetings.length > 0) {
            linkItems += `<div style="color: var(--text-secondary); font-size: 0.875rem;">üìÖ ${del.linked_meetings.length} tilknyttede m√∏ter</div>`;
          }
          if (
            del.linked_timeline_events &&
            del.linked_timeline_events.length > 0
          ) {
            linkItems += `<div style="color: var(--text-secondary); font-size: 0.875rem;">üìç ${del.linked_timeline_events.length} tilknyttede hendelser</div>`;
          }
          linksHtml = `
          <div class="detail-section">
            <div class="section-header" onclick="toggleSection(this)">
              <span class="section-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
                Tilknytninger
              </span>
              <svg class="section-toggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
            <div class="section-content">${linkItems}</div>
          </div>
        `;
        }

        let html = `
        <div class="detail-content">
          <div class="detail-header">
            <div class="detail-status-badge ${del.status}">
              ${getStatusIcon(del.status)} ${getStatusLabel(del.status)}
            </div>
            <h2 class="detail-title">${sanitize(del.title_no || del.title)}</h2>

            <div class="detail-meta-grid">
              <div class="meta-item">
                <span class="meta-label">Kategori</span>
                <span class="category-badge">${emoji} ${cat.name_no || cat.name}</span>
              </div>
              ${
                del.importance
                  ? `
                <div class="meta-item">
                  <span class="meta-label">Prioritet</span>
                  <span class="meta-value">${del.importance === "critical" ? "Kritisk" : del.importance === "high" ? "H√∏y" : "Normal"}</span>
                </div>
              `
                  : ""
              }
              ${
                del.related_organizations &&
                del.related_organizations.length > 0
                  ? `
                <div class="meta-item">
                  <span class="meta-label">Organisasjoner</span>
                  <span class="meta-value">${del.related_organizations.join(", ")}</span>
                </div>
              `
                  : ""
              }
            </div>
          </div>

          ${timelineHtml}
          ${responsibleHtml}
          ${linksHtml}
        </div>
      `;

        panel.innerHTML = html;
      }

      function toggleSection(header) {
        const section = header.parentElement;
        section.classList.toggle("expanded");
      }

      // ===== INITIALIZATION =====
      async function init() {
        try {
          // Load deliverables
          const delResponse = await fetch("data/deliverables.json");
          const delData = await delResponse.json();
          allDeliverables = delData.deliverables || [];
          categories = delData.categories || [];

          // Load people for responsible mapping
          try {
            const peopleResponse = await fetch(
              "data/stakeholders/people.json",
            );
            const peopleData = await peopleResponse.json();
            const peopleSource = peopleData.people || peopleData || {};
            const people = Array.isArray(peopleSource)
              ? peopleSource
              : Object.values(peopleSource);
            people.forEach((p) => {
              if (!p || !p.id) return;
              peopleMap[p.id] = p;
            });
          } catch (e) {
            console.warn("Could not load people data");
          }

          // Update stats
          const completed = allDeliverables.filter(
            (d) => d.status === "completed",
          ).length;
          const inProgress = allDeliverables.filter((d) =>
            ["in_progress", "in_production", "in_planning"].includes(d.status),
          ).length;

          document.getElementById("stat-total").textContent =
            allDeliverables.length;
          document.getElementById("stat-completed").textContent = completed;
          document.getElementById("stat-progress").textContent = inProgress;

          // Populate category filter
          const categorySelect = document.getElementById("filter-category");
          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.id;
            option.textContent = cat.name_no || cat.name;
            categorySelect.appendChild(option);
          });

          // Apply initial filters
          applyFilters();

          // Setup event listeners
          setupEventListeners();

          // Auto-select first
          if (filteredDeliverables.length > 0) {
            selectDeliverable(filteredDeliverables[0].id);
          }
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("deliverable-list").innerHTML =
            '<div class="loading-state"><span>Feil ved lasting av leveranser</span></div>';
        }
      }

      function setupEventListeners() {
        // Search
        let searchTimeout;
        document
          .getElementById("search-input")
          .addEventListener("input", (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              searchQuery = e.target.value;
              applyFilters();
            }, 200);
          });

        // Category filter
        document
          .getElementById("filter-category")
          .addEventListener("change", (e) => {
            categoryFilter = e.target.value;
            applyFilters();
          });

        // Status filter
        document
          .getElementById("filter-status")
          .addEventListener("change", (e) => {
            statusFilter = e.target.value;
            applyFilters();
          });
      }

      // Start
      ContentHeader.inject("deliverables");
      init();
    </script>
  </body>
</html>
